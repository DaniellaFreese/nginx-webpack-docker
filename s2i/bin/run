#!/bin/bash

source /opt/app-root/etc/generate_container_user

set -e

if [ -d ${NGINX_GLOBAL_CONFIGURATION_PATH} ] ; then
    for i in ${NGINX_GLOBAL_CONFIGURATION_PATH}/*.conf.erb ; do
	cat $i | erb > ${i%%.erb}
    done
fi

if [ -d ${NGINX_HTTP_GLOBAL_SERVER_CONFIGURATION_PATH} ] ; then
    for i in ${NGINX_HTTP_GLOBAL_SERVER_CONFIGURATION_PATH}/*.conf.erb ; do
	cat $i | erb > ${i%%.erb}
    done 
fi

if [ -d ${NGINX_DEFAULT_SERVER_CONFIGURATION_PATH} ] ; then
    for i in ${NGINX_DEFAULT_SERVER_CONFIGURATION_PATH}/*.conf.erb ; do
	cat $i | erb > ${i%%.erb}
    done
fi

# Legacy;  remove after updates made to application
if [ -d "/opt/app-root/etc/nginx.default.d" ] ; then
    for i in /opt/app-root/etc/nginx.default.d/*.conf.erb ; do
	cat $i | erb > ${i%%.erb}
    done
fi

exec nginx -g "daemon off;"
